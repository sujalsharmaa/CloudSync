apiVersion: v1
kind: ConfigMap
metadata:
  name: payment-service-config
  namespace: default
data:
  application.yaml: |
    server:
      port: 8084

    redirect_url_success: https://drive.sujalsharma.in/

    spring:
      application:
        name: payment-service

      main:
        allow-bean-definition-overriding: true

      # === Redis ===
      data:
        redis:
          host: redis.default.svc.cluster.local
          port: 6379

      # === Security ===
      security:
        oauth2:
          resourceserver:
            jwt:
              issuer-uri: https://accounts.google.com

      # === Kafka ===
      kafka:
        bootstrap-servers: kafka-service.default.svc.cluster.local:9092
        producer:
          key-serializer: org.apache.kafka.common.serialization.StringSerializer
          value-serializer: org.apache.kafka.common.serialization.StringSerializer
        consumer:
          group-id: rag-pipeline-group
          auto-offset-reset: earliest
          key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
          value-deserializer: org.apache.kafka.common.serialization.StringDeserializer

      # === PostgreSQL ===
      datasource:
        url: jdbc:postgresql://postgres.default.svc.cluster.local:5432/postgres
        driver-class-name: org.postgresql.Driver
        # username & password injected from Secret

      jpa:
        hibernate:
          ddl-auto: update
        show-sql: true
        properties:
          hibernate:
            format_sql: true
            dialect: org.hibernate.dialect.PostgreSQLDialect

      # === Elasticsearch ===
      elasticsearch:
        uris: http://elasticsearch.default.svc.cluster.local:9200
        # credentials injected from Secret

      # === Spring AI ===
      ai:
        vectorstore:
          chroma:
            client-host: chroma.default.svc.cluster.local
            client-port: 8000
            collection-name: drive-documents
        autoconfigure:
          exclude:
            - org.springframework.ai.model.openai.autoconfigure.OpenAiAudioSpeechAutoConfiguration
            - org.springframework.ai.vectorstore.chroma.autoconfigure.ChromaVectorStoreAutoConfiguration

    # === LangChain4j / GenAI ===
    genai:
      provider: gemini
      gemini:
        model:
          text: gemini-2.0-flash-001
          code: gemini-2.0-flash-001
          image: gemini-2.0-flash-001
          embedding: text-embedding-004
          video: gemini-2.0-flash-001

    # === Stripe ===
    stripe:
      # secretKey & webhook.secret injected from Secret
      secretKey: ""
      webhook:
        secret: ""

    # === Resilience4j ===
    resilience4j:
      circuitbreaker:
        instances:
          stripeService:
            registerHealthIndicator: true
            slidingWindowSize: 10
            minimumNumberOfCalls: 5
            permittedNumberOfCallsInHalfOpenState: 3
            automaticTransitionFromOpenToHalfOpenEnabled: true
            waitDurationInOpenState: 5s
            failureRateThreshold: 50
            eventConsumerBufferSize: 10
            recordExceptions:
              - org.springframework.web.client.HttpServerErrorException
              - java.util.concurrent.TimeoutException
              - java.io.IOException
              - com.stripe.exception.StripeException
            ignoreExceptions:
              - com.payment.payment.Exception.BusinessException

    # === Actuator ===
    management:
      health:
        circuitbreakers:
          enabled: true
      endpoints:
        web:
          exposure:
            include:
              - health
              - info
              - circuitbreakers
              - prometheus
      tracing:
        sampling:
          probability: 1.0
      otlp:
        tracing:
          endpoint: http://tempo.default.svc.cluster.local:4318/v1/traces

    # === Swagger ===
    springdoc:
      api-docs:
        path: /v3/api-docs
        enabled: true
      swagger-ui:
        path: /swagger-ui.html
        enabled: true
        operationsSorter: method
        tagsSorter: alpha
        displayRequestDuration: true
        filter: true
      show-actuator: false

    # === App Info ===
    info:
      app:
        name: Payment Service
        description: Payment gateway service for CloudSync
        version: 1.0.0
        contact:
          name: CloudSync Team
          email: support@cloudsync.com
