---
# DestinationRule for Auth Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: auth-service-circuit-breaker
  namespace: default
spec:
  host: cloudsync-auth-service-service.default.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50

---
# DestinationRule for Upload Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: upload-service-circuit-breaker
  namespace: default
spec:
  host: cloudsync-upload-service-service.default.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200  # Higher for file uploads
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 200
        maxRequestsPerConnection: 1
    outlierDetection:
      consecutiveErrors: 3
      interval: 20s
      baseEjectionTime: 60s  # Longer ejection for upload failures
      maxEjectionPercent: 30

---
# DestinationRule for Search Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: search-service-circuit-breaker
  namespace: default
spec:
  host: cloudsync-search-service-service.default.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 150
      http:
        http1MaxPendingRequests: 75
        http2MaxRequests: 150
        maxRequestsPerConnection: 3
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# DestinationRule for Tags Generation Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: tags-generation-circuit-breaker
  namespace: default
spec:
  host: cloudsync-tags-generation-service-service.default.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutiveErrors: 3  # Stricter for AI processing
      interval: 30s
      baseEjectionTime: 90s  # Longer recovery time
      maxEjectionPercent: 40

---
# DestinationRule for Payment Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: payment-service-circuit-breaker
  namespace: default
spec:
  host: cloudsync-payment-service-service.default.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 50  # Lower for critical payment operations
      http:
        http1MaxPendingRequests: 25
        http2MaxRequests: 50
        maxRequestsPerConnection: 1
    outlierDetection:
      consecutiveErrors: 2  # Very strict
      interval: 60s
      baseEjectionTime: 120s  # Longer recovery
      maxEjectionPercent: 25

---
# DestinationRule for Notification Service
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: notification-service-circuit-breaker
  namespace: default
spec:
  host: cloudsync-notification-service-service.default.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
    outlierDetection:
      consecutiveErrors: 10  # More lenient - notifications can be retried
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 60

---
# Virtual Service with Retry and Timeout Policies
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: auth-service-resilience
  namespace: default
spec:
  hosts:
    - cloudsync-auth-service-service.default.svc.cluster.local
  http:
    - route:
        - destination:
            host: cloudsync-auth-service-service.default.svc.cluster.local
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: 5xx,reset,connect-failure,refused-stream
      timeout: 10s
      fault:
        abort:
          percentage:
            value: 0.0  # Set to 0.1 for chaos testing
          httpStatus: 503

---
# Virtual Service for Upload Service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: upload-service-resilience
  namespace: default
spec:
  hosts:
    - cloudsync-upload-service-service.default.svc.cluster.local
  http:
    - route:
        - destination:
            host: cloudsync-upload-service-service.default.svc.cluster.local
      retries:
        attempts: 2  # Fewer retries for uploads
        perTryTimeout: 30s  # Longer timeout for file uploads
        retryOn: reset,connect-failure,refused-stream
      timeout: 120s  # 2 minute timeout for uploads